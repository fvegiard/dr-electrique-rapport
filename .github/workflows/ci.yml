name: DR Électrique CI/CD

on:
  push:
    branches: [main, 'feature/*']
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Health check every 6 hours
    - cron: '0 */6 * * *'

env:
  SUPABASE_URL: https://iawsshgkogntmdzrfjyw.supabase.co
  NETLIFY_SITE_ID: bc99f38e-70f5-4eb9-8df6-4900c66fae04

jobs:
  # ============================================
  # LINT & TYPECHECK
  # ============================================
  lint-and-typecheck:
    name: Lint & TypeScript Check
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run TypeScript check
        run: npm run type-check

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

  # ============================================
  # UNIT TESTS
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run unit tests
        run: npm run test
        continue-on-error: true

  # ============================================
  # VALIDATE: Supabase + Code Structure
  # ============================================
  validate:
    name: Validate Supabase & Code
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Test Supabase REST API
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            "${{ env.SUPABASE_URL }}/rest/v1/rapports?select=id&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")

          http_code=$(echo "$response" | tail -n1)
          echo "HTTP Status: $http_code"

          if [ "$http_code" != "200" ]; then
            echo "::error::Supabase REST API failed with status $http_code"
            exit 1
          fi
          echo "Supabase REST API: OK"

      - name: Test Supabase Storage
        run: |
          # Test upload capability to rapport-photos bucket
          test_path="test/ci-test-$(date +%s).txt"

          upload_response=$(curl -s -w "\n%{http_code}" \
            "${{ env.SUPABASE_URL }}/storage/v1/object/photos/${test_path}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: text/plain" \
            -X POST \
            -d "ci-test-upload")

          upload_code=$(echo "$upload_response" | tail -n1)

          if [ "$upload_code" = "200" ] || [ "$upload_code" = "201" ]; then
            echo "Storage upload: OK"
            # Cleanup test file
            curl -s -X DELETE \
              "${{ env.SUPABASE_URL }}/storage/v1/object/photos/${test_path}" \
              -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
              -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" > /dev/null
          else
            echo "::warning::Storage upload returned status $upload_code (bucket may need RLS policy)"
          fi

      - name: Validate Source Code Structure
        run: |
          echo "Checking critical components..."

          checks=(
            "handleSubmit:src/components/RapportForm.tsx"
            "PhotoUploadGPS:src/components/form/PhotoUploadGPS.tsx"
            "calculateHours:src/components/RapportForm.tsx"
            "uploadPhotosWithRetry:src/lib/photoTransaction.ts"
            "supabase:src/services/supabase.ts"
          )

          for check in "${checks[@]}"; do
            func="${check%%:*}"
            file="${check##*:}"
            if [ -f "$file" ] && grep -q "$func" "$file"; then
              echo "Found: $func in $file"
            else
              echo "::error::Missing critical code: $func in $file"
              exit 1
            fi
          done

      - name: Validate Netlify Functions
        run: |
          if [ -f "netlify/functions/claude-vision.js" ]; then
            node --check netlify/functions/claude-vision.js
            echo "Claude Vision function: OK"
          else
            echo "::warning::Claude Vision function not found"
          fi

  # ============================================
  # E2E TESTS (push only, continue-on-error)
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    if: github.event_name == 'push'
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npm run test:e2e
        env:
          CI: true
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ============================================
  # WAIT FOR NETLIFY PREVIEW (PRs only)
  # ============================================
  wait-for-netlify:
    name: Wait for Netlify Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      preview_url: ${{ steps.wait-netlify.outputs.url }}

    steps:
      - name: Wait for Netlify Deploy
        id: wait-netlify
        uses: jakepartusch/wait-for-netlify-action@v1.4
        with:
          site_id: ${{ env.NETLIFY_SITE_ID }}
          max_timeout: 300
        env:
          NETLIFY_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

  # ============================================
  # E2E TESTS PREVIEW (PRs only)
  # ============================================
  e2e-tests-preview:
    name: E2E Tests (Preview)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, wait-for-netlify]
    if: github.event_name == 'pull_request'
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests against preview
        run: npm run test:e2e
        env:
          CI: true
          BASE_URL: ${{ needs.wait-for-netlify.outputs.preview_url }}
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-preview
          path: playwright-report/
          retention-days: 7

  # ============================================
  # DEPLOY TO PRODUCTION (main branch only)
  # ============================================
  deploy:
    name: Deploy to Netlify
    needs: [lint-and-typecheck, validate]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: '.'
          production-deploy: true
          functions-dir: './netlify/functions'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ env.NETLIFY_SITE_ID }}

      - name: Verify Deployment
        run: |
          sleep 15
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "https://dr-electrique-rapport.netlify.app")
          if [ "$http_code" = "200" ]; then
            echo "Production site: OK"
          else
            echo "::warning::Site returned status $http_code"
          fi

  # ============================================
  # PR COMMENT WITH RESULTS (PRs only)
  # ============================================
  post-pr-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, unit-tests, e2e-tests-preview]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write

    steps:
      - name: Generate Test Summary
        id: test-summary
        run: |
          LINT_STATUS="${{ needs.lint-and-typecheck.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests-preview.result }}"

          get_emoji() {
            case "$1" in
              "success") echo "pass" ;;
              "failure") echo "FAIL" ;;
              "skipped") echo "skip" ;;
              *) echo "warn" ;;
            esac
          }

          echo "lint_status=$(get_emoji "$LINT_STATUS") $LINT_STATUS" >> $GITHUB_OUTPUT
          echo "unit_status=$(get_emoji "$UNIT_STATUS") $UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "e2e_status=$(get_emoji "$E2E_STATUS") $E2E_STATUS" >> $GITHUB_OUTPUT

          if [ "$LINT_STATUS" = "success" ]; then
            echo "overall=All checks passed" >> $GITHUB_OUTPUT
          else
            echo "overall=Some checks failed" >> $GITHUB_OUTPUT
          fi

      - name: Post Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ needs.wait-for-netlify.outputs.preview_url }}' || 'N/A';
            const body = `## Test Results — ${{ steps.test-summary.outputs.overall }}

            | Check | Result |
            |-------|--------|
            | TypeScript & Lint | ${{ steps.test-summary.outputs.lint_status }} |
            | Unit Tests | ${{ steps.test-summary.outputs.unit_status }} |
            | E2E Tests | ${{ steps.test-summary.outputs.e2e_status }} |

            **Preview:** ${previewUrl}
            **Commit:** \`${context.sha.substring(0, 7)}\`
            **Run:** [Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ---
            *Auto-generated by CI/CD Pipeline*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user?.type === 'Bot' && c.body?.includes('## Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ============================================
  # HEALTH CHECK (scheduled only)
  # ============================================
  health-check:
    name: Scheduled Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Check All Systems
        id: health
        run: |
          site=$(curl -s -o /dev/null -w "%{http_code}" "https://dr-electrique-rapport.netlify.app")
          api=$(curl -s -o /dev/null -w "%{http_code}" \
            "${{ env.SUPABASE_URL }}/rest/v1/" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}")
          db=$(curl -s -o /dev/null -w "%{http_code}" \
            "${{ env.SUPABASE_URL }}/rest/v1/rapports?select=id&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")
          dashboard=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://dr-electrique-rapport.netlify.app/dashboard-a2c15af64b97e73f.html")

          echo "Site: $site | API: $api | DB: $db | Dashboard: $dashboard"
          echo "site=$site" >> $GITHUB_OUTPUT
          echo "api=$api" >> $GITHUB_OUTPUT
          echo "db=$db" >> $GITHUB_OUTPUT
          echo "dashboard=$dashboard" >> $GITHUB_OUTPUT

          if [ "$site" != "200" ] || [ "$api" != "200" ] || [ "$db" != "200" ]; then
            echo "::error::Health check failed"
            exit 1
          fi
          echo "All systems operational"

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Health Check Failed - ${new Date().toISOString().split('T')[0]}`;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'health-check',
              state: 'open'
            });

            if (issues.find(i => i.title === title)) return;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: `## Health Check Failed\n\n**Time:** ${new Date().toISOString()}\n\n| Check | Status |\n|-------|--------|\n| Site | ${{ steps.health.outputs.site || 'N/A' }} |\n| API | ${{ steps.health.outputs.api || 'N/A' }} |\n| DB | ${{ steps.health.outputs.db || 'N/A' }} |\n| Dashboard | ${{ steps.health.outputs.dashboard || 'N/A' }} |\n\n[Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'health-check', 'automated']
            });

  # ============================================
  # NOTIFY ON FAILURE
  # ============================================
  notify-on-failure:
    name: Log Failure
    needs: [lint-and-typecheck, validate, deploy]
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'push'

    steps:
      - name: Log CI Failure
        run: |
          echo "::error::CI/CD Pipeline failed for commit ${{ github.sha }}"
          echo "Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
