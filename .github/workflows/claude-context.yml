name: Build Claude Context

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-context:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate Context
        run: |
          # Get repo stats
          TOTAL_FILES=$(find . -type f -not -path './.git/*' | wc -l)
          LANGUAGES=$(find . -type f -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.sh" | xargs -I{} basename {} | sed 's/.*\.//' | sort | uniq -c | sort -rn | head -5 | awk '{print $2}' | tr '\n' ', ' | sed 's/,$//')
          
          # Get recent commits
          RECENT_COMMITS=$(git log -5 --format="- %h %s (%ar)" 2>/dev/null || echo "None")
          
          # Get directory structure
          DIR_STRUCTURE=$(find . -type d -not -path './.git*' | head -20 | sed 's/^//')
          
          # Generate CONTEXT.md
          cat > .claude/CONTEXT.md << INNER_EOF
          # Auto-Generated Context

          ## Repository Stats
          - **Total Files:** $TOTAL_FILES
          - **Languages:** $LANGUAGES
          - **Last Updated:** $(date -u +"%Y-%m-%d %H:%M UTC")

          ## Recent Commits
          \`\`\`
          $RECENT_COMMITS
          \`\`\`

          ## Open Issues
          $(gh issue list --limit 5 2>/dev/null || echo "- Unable to fetch (no token)")

          ## Directory Structure
          \`\`\`
          $DIR_STRUCTURE
          \`\`\`

          ---
          *Auto-generated by GitHub Action - Do not edit manually*
          INNER_EOF
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit Context
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .claude/CONTEXT.md
          git diff --staged --quiet || git commit -m "chore: auto-update context"
          git push
