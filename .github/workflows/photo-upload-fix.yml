name: Photo Upload - Supabase Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  SUPABASE_URL: https://iawsshgkogntmdzrfjyw.supabase.co

jobs:
  test-supabase-connection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Supabase Database
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            "${{ env.SUPABASE_URL }}/rest/v1/rapports?select=id&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")

          http_code=$(echo "$response" | tail -n1)
          echo "Database HTTP Status: $http_code"

          if [ "$http_code" != "200" ]; then
            echo "::error::Supabase database connection failed with status $http_code"
            exit 1
          fi
          echo "Database connection: OK"

      - name: Test Supabase Storage Bucket
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            "${{ env.SUPABASE_URL }}/storage/v1/bucket/photos" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")

          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" = "200" ]; then
            echo "Storage bucket 'photos': OK"
          elif [ "$http_code" = "404" ]; then
            echo "::warning::Storage bucket 'photos' not found - photo upload will fail"
          else
            echo "::warning::Storage check returned status $http_code"
          fi

      - name: Test Storage Upload Capability
        run: |
          test_path="test/ci-test-$(date +%s).txt"

          upload_response=$(curl -s -w "\n%{http_code}" \
            "${{ env.SUPABASE_URL }}/storage/v1/object/photos/${test_path}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: text/plain" \
            -X POST \
            -d "ci-test-upload")

          upload_code=$(echo "$upload_response" | tail -n1)

          if [ "$upload_code" = "200" ] || [ "$upload_code" = "201" ]; then
            echo "Upload test: OK"

            curl -s -X DELETE \
              "${{ env.SUPABASE_URL }}/storage/v1/object/photos/${test_path}" \
              -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
              -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" > /dev/null

            echo "Cleanup: OK"
          else
            echo "::warning::Upload test returned status $upload_code (bucket may need RLS policy)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "==========================================="
          echo "  SUPABASE PHOTO PIPELINE VALIDATION"
          echo "==========================================="
          echo "  Database:  Tested"
          echo "  Storage:   Tested"
          echo "  Upload:    Tested"
          echo "==========================================="
