name: Test & Deploy Pipeline

on:
  push:
    branches:
      - main
      - 'feature/*'
  pull_request:
    branches:
      - main

env:
  NETLIFY_SITE_ID: bc99f38e-70f5-4eb9-8df6-4900c66fae04
  SUPABASE_URL: https://iawsshgkogntmdzrfjyw.supabase.co

jobs:
  # ============================================
  # LINT & TYPE CHECK
  # ============================================
  lint-and-typecheck:
    name: Lint & TypeScript Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run TypeScript check
        run: npm run type-check

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

  # ============================================
  # UNIT TESTS
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run unit tests
        run: npm run test
        continue-on-error: true

  # ============================================
  # WAIT FOR NETLIFY PREVIEW
  # ============================================
  wait-for-netlify:
    name: Wait for Netlify Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      preview_url: ${{ steps.wait-netlify.outputs.url }}

    steps:
      - name: Wait for Netlify Deploy
        id: wait-netlify
        uses: jakepartusch/wait-for-netlify-action@v1.4
        with:
          site_id: ${{ env.NETLIFY_SITE_ID }}
          max_timeout: 300
        env:
          NETLIFY_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: Output Preview URL
        run: |
          echo "Preview URL: ${{ steps.wait-netlify.outputs.url }}"

  # ============================================
  # E2E TESTS - LOCAL (for push to feature/*)
  # ============================================
  e2e-tests-local:
    name: E2E Tests (Local)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npm run test:e2e
        env:
          CI: true
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-local
          path: playwright-report/
          retention-days: 7

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-local
          path: test-results/
          retention-days: 7

  # ============================================
  # E2E TESTS - PREVIEW (for PRs)
  # ============================================
  e2e-tests-preview:
    name: E2E Tests (Preview)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, wait-for-netlify]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests against preview
        run: npm run test:e2e
        env:
          CI: true
          BASE_URL: ${{ needs.wait-for-netlify.outputs.preview_url }}
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-preview
          path: playwright-report/
          retention-days: 7

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-preview
          path: test-results/
          retention-days: 7

  # ============================================
  # POST PR COMMENT WITH RESULTS
  # ============================================
  post-pr-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, unit-tests, e2e-tests-preview]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write

    steps:
      - name: Download Playwright Report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-preview
          path: playwright-report
        continue-on-error: true

      - name: Generate Test Summary
        id: test-summary
        run: |
          # Determine status for each job
          LINT_STATUS="${{ needs.lint-and-typecheck.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests-preview.result }}"

          # Set emoji based on status
          get_emoji() {
            case "$1" in
              "success") echo "âœ…" ;;
              "failure") echo "âŒ" ;;
              "skipped") echo "â­ï¸" ;;
              *) echo "âš ï¸" ;;
            esac
          }

          LINT_EMOJI=$(get_emoji "$LINT_STATUS")
          UNIT_EMOJI=$(get_emoji "$UNIT_STATUS")
          E2E_EMOJI=$(get_emoji "$E2E_STATUS")

          # Overall status
          if [ "$LINT_STATUS" = "success" ] && [ "$E2E_STATUS" = "success" ]; then
            OVERALL="âœ… All checks passed!"
            OVERALL_STATUS="success"
          elif [ "$LINT_STATUS" = "failure" ] || [ "$E2E_STATUS" = "failure" ]; then
            OVERALL="âŒ Some checks failed"
            OVERALL_STATUS="failure"
          else
            OVERALL="âš ï¸ Checks completed with warnings"
            OVERALL_STATUS="warning"
          fi

          # Save to outputs
          echo "lint_emoji=$LINT_EMOJI" >> $GITHUB_OUTPUT
          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "unit_emoji=$UNIT_EMOJI" >> $GITHUB_OUTPUT
          echo "unit_status=$UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "e2e_emoji=$E2E_EMOJI" >> $GITHUB_OUTPUT
          echo "e2e_status=$E2E_STATUS" >> $GITHUB_OUTPUT
          echo "overall=$OVERALL" >> $GITHUB_OUTPUT
          echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT

      - name: Post Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const lintEmoji = '${{ steps.test-summary.outputs.lint_emoji }}';
            const lintStatus = '${{ steps.test-summary.outputs.lint_status }}';
            const unitEmoji = '${{ steps.test-summary.outputs.unit_emoji }}';
            const unitStatus = '${{ steps.test-summary.outputs.unit_status }}';
            const e2eEmoji = '${{ steps.test-summary.outputs.e2e_emoji }}';
            const e2eStatus = '${{ steps.test-summary.outputs.e2e_status }}';
            const overall = '${{ steps.test-summary.outputs.overall }}';

            const previewUrl = '${{ needs.wait-for-netlify.outputs.preview_url }}' || 'N/A';

            const body = `## Test Results

            ${overall}

            | Check | Status |
            |-------|--------|
            | ${lintEmoji} TypeScript & Lint | ${lintStatus} |
            | ${unitEmoji} Unit Tests | ${unitStatus} |
            | ${e2eEmoji} E2E Tests | ${e2eStatus} |

            ### Preview Deployment
            ðŸ”— **Preview URL:** ${previewUrl}

            ### Artifacts
            - [Playwright Report](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) (download from workflow artifacts)

            ---
            <details>
            <summary>ðŸ“‹ Workflow Details</summary>

            - **Commit:** \`${context.sha.substring(0, 7)}\`
            - **Branch:** \`${context.payload.pull_request?.head?.ref || 'N/A'}\`
            - **Workflow Run:** [View Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            </details>

            ---
            *Generated by CI/CD Pipeline*`;

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(comment =>
              comment.user?.type === 'Bot' &&
              comment.body?.includes('## Test Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing PR comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new PR comment');
            }

  # ============================================
  # DEPLOY TO PRODUCTION (main branch only)
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, e2e-tests-local]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Netlify (Production)
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: '.'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ env.NETLIFY_SITE_ID }}

      - name: Verify Production Deployment
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 15

          response=$(curl -s -w "\n%{http_code}" "https://dr-electrique-rapport.netlify.app")
          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" = "200" ]; then
            echo "âœ… Production site is live and responding"
          else
            echo "âš ï¸ Site returned status $http_code"
          fi

  # ============================================
  # NOTIFY ON FAILURE
  # ============================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, e2e-tests-local, e2e-tests-preview]
    if: failure() && github.event_name == 'push'
    permissions:
      issues: write

    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `CI Pipeline Failed - ${context.sha.substring(0, 7)}`;

            // Check for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });

            const existingIssue = issues.find(i => i.title === title);

            if (existingIssue) {
              console.log('Issue already exists for this commit');
              return;
            }

            const body = `## CI Pipeline Failed

            **Commit:** \`${context.sha}\`
            **Branch:** \`${context.ref}\`
            **Workflow Run:** [View Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ### Failure Summary
            Check the workflow run for detailed error logs.

            ### Common Fixes
            - **TypeScript errors:** Run \`npm run type-check\` locally
            - **E2E failures:** Check Playwright report in artifacts
            - **Lint errors:** Run \`npm run lint:fix\`

            ---
            *Auto-generated by CI Pipeline*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'ci-failure', 'automated']
            });

            console.log('Created failure issue');
