<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rapport Journalier - DR √âlectrique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#E63946">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root { --dr-red: #E63946; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg, #0a0a0a 0%, #141414 100%); min-height: 100vh; margin: 0; }
        .font-bebas { font-family: 'Bebas Neue', sans-serif; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #E63946; border-radius: 2px; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(230,57,70,0.5); } 50% { box-shadow: 0 0 0 20px rgba(230,57,70,0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes checkmark { 0% { stroke-dashoffset: 100; } 100% { stroke-dashoffset: 0; } }
        @keyframes analyzing { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        .animate-pulse-btn { animation: pulse 2s infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-check { animation: checkmark 0.5s ease-out forwards; }
        .animate-analyzing { animation: analyzing 1s infinite; }
        
        .glass { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.06); }
        
        input, select, textarea { 
            background: rgba(10, 10, 10, 0.9) !important; 
            border: 1px solid rgba(255,255,255,0.1) !important; 
            color: white !important; 
            font-size: 16px !important;
            transition: all 0.2s;
            -webkit-appearance: none;
            appearance: none;
            border-radius: 12px !important;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: #E63946 !important; 
            outline: none !important; 
            box-shadow: 0 0 0 3px rgba(230,57,70,0.2) !important; 
        }
        input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.3) !important; }
        
        select { 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 12px center !important;
            padding-right: 40px !important;
        }
        
        .section-header {
            background: linear-gradient(135deg, var(--color) 0%, color-mix(in srgb, var(--color) 70%, black) 100%);
        }
        
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 8px; }
        .photo-item { aspect-ratio: 1; object-fit: cover; border-radius: 10px; }
        
        .extra-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
        }
        
        .time-picker-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            transition: all 0.15s;
            user-select: none;
            -webkit-user-select: none;
        }
        .time-picker-btn:active {
            background: #E63946;
            transform: scale(0.95);
        }
        
        .time-display {
            font-family: 'Inter', sans-serif;
            font-size: 22px;
            font-weight: 600;
            letter-spacing: 1px;
            min-width: 50px;
            text-align: center;
        }
        
        .gps-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .ai-analyzing {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ============== SUPABASE CONFIG ==============
        const SUPABASE_URL = 'https://iawsshgkogntmdzrfjyw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhd3NzaGdrb2dudG1kenJmanl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NDkwMDUsImV4cCI6MjA4MzIyNTAwNX0.1BxhI5SWLL5786qsshidOMpTsOrGeNob6xpcKQjI4s4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ============== EMAILJS CONFIG ==============
        const EMAILJS_SERVICE_ID = 'service_drelectrique';  // A configurer sur emailjs.com
        const EMAILJS_TEMPLATE_ID = 'template_rapport';     // A configurer sur emailjs.com
        const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';       // A configurer sur emailjs.com
        const EMAIL_BACKUP_TO = 'fvegiard@dreelectrique.com';
        
        // Init EmailJS
        if (window.emailjs && EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
            window.emailjs.init(EMAILJS_PUBLIC_KEY);
        }
        
        // ============== CONFIG ==============
        
        const EMPLOYES = [
            { id: 1, nom: "Maxime Robert", role: "Contremaitre" },
            { id: 2, nom: "Martin B.", role: "Ajoute" },
            { id: 3, nom: "Patrick R.", role: "Ajoute" },
            { id: 4, nom: "Nathael", role: "Ajoute" },
            { id: 5, nom: "Benjamin M.", role: "Ajoute" },
            { id: 6, nom: "Jonathan F.", role: "Ajoute" },
            { id: 7, nom: "Ahmad", role: "Ajoute" },
            { id: 8, nom: "Vincent Tibeault", role: "Ajoute" }
        ];
        
        // Workers for main d'oeuvre (includes all staff)
        const WORKERS = [
            "Maxime Robert", "Martin B.", "Patrick R.", "Nathael",
            "Benjamin M.", "Jonathan F.", "Ahmad", "Vincent Tibeault"
        ];
        
        const PROJETS = [
            { id: "PRJ-001", nom: "Alexis Nihon", client: "Cominar" },
            { id: "PRJ-002", nom: "Electric Kahnawake", client: "MCK" },
            { id: "PRJ-003", nom: "Fairview Pointe-Claire", client: "Cadillac Fairview" },
            { id: "PRJ-004", nom: "Data Center MTL-01", client: "SIP √âlectrique" },
            { id: "PRJ-005", nom: "Tour des Canadiens 4", client: "Canderel" },
        ];
        
        const MATERIAUX_COMMUNS = [
            "Fil 14/2 NMD", "Fil 12/2 NMD", "Fil 10/3 NMD", "C√¢ble TECK 3C #10",
            "Bo√Æte 4x4", "Bo√Æte octogonale", "Conduit EMT 3/4\"", "Conduit EMT 1\"",
            "Connecteur EMT 3/4\"", "Disjoncteur 15A", "Disjoncteur 20A", "Disjoncteur 30A 2P",
            "Prise 15A", "Prise 20A", "Prise GFCI", "Interrupteur simple", "Interrupteur 3-way",
            "Luminaire LED 2x4", "Luminaire LED 1x4", "Pot light 4\"", "Pot light 6\"",
            "Panneau 100A", "Panneau 200A", "Barre de mise √† terre", "C√¢ble Teck 4C #8",
            "Conduit rigide 1\"", "Connecteur √©tanche", "Bo√Æte de jonction 6x6",
            "Fil THHN #12", "Fil THHN #10", "Fil THHN #8", "C√¢ble AC90 #12"
        ];
        
        const LOCAL_STORAGE_KEY = 'dr_rapports_pending';
        
        // ============== UTILS ==============
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        const getTodayStr = () => new Date().toISOString().split('T')[0];
        
        const savePendingRapport = (rapport) => {
            const pending = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            pending.push(rapport);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pending));
        };
        
        // ============== EMAIL BACKUP ==============
        const sendEmailBackup = async (rapport) => {
            if (!window.emailjs || EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                console.log('EmailJS non configure - email non envoye');
                return { success: false, reason: 'not_configured' };
            }
            
            const formatMainOeuvre = (mo) => {
                if (!mo || mo.length === 0) return 'Aucun';
                return mo.map(e => `${e.nom}: ${e.debut}-${e.fin} (${e.description || 'N/A'})`).join('\n');
            };
            
            const formatMateriaux = (mat) => {
                if (!mat || mat.length === 0) return 'Aucun';
                return mat.map(m => `- ${m.description} (Qte: ${m.quantite || 1})`).join('\n');
            };
            
            const templateParams = {
                to_email: EMAIL_BACKUP_TO,
                date: rapport.date,
                redacteur: rapport.redacteur,
                projet: rapport.projetNom || rapport.projet,
                adresse: rapport.adresse,
                meteo: rapport.meteo,
                temperature: rapport.temperature,
                main_oeuvre: formatMainOeuvre(rapport.mainOeuvre),
                materiaux: formatMateriaux(rapport.materiaux),
                equipements: (rapport.equipements || []).join(', ') || 'Aucun',
                notes: rapport.notesGenerales || 'Aucune',
                total_heures: rapport.totalHeuresMO || 0,
                timestamp: new Date().toLocaleString('fr-CA')
            };
            
            try {
                const response = await window.emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                console.log('Email backup envoye:', response.status);
                return { success: true };
            } catch (err) {
                console.error('Email backup echoue:', err);
                return { success: false, error: err };
            }
        };
        
        // ============== DEBUG & TEST SUPABASE ==============
        const testSupabaseConnection = async () => {
            console.log('TEST SUPABASE - Debut...');
            const results = [];
            
            try {
                // Test 1: SELECT
                console.log('Test SELECT...');
                const { data: selectData, error: selectError } = await supabase.from('rapports').select('id, redacteur').limit(3);
                if (selectError) {
                    results.push('SELECT FAIL: ' + selectError.message);
                    console.error('SELECT error:', selectError);
                } else {
                    results.push('SELECT OK - ' + (selectData?.length || 0) + ' rapports');
                    console.log('SELECT data:', selectData);
                }
                
                // Test 2: INSERT test row
                console.log('Test INSERT...');
                const testData = {
                    date: new Date().toISOString().split('T')[0],
                    redacteur: '__TEST_CONNECTION__',
                    projet: 'TEST',
                    adresse: 'Test address',
                    meteo: 'test',
                    temperature: 0
                };
                const { data: insertData, error: insertError } = await supabase.from('rapports').insert([testData]).select();
                if (insertError) {
                    results.push('INSERT FAIL: ' + insertError.message + ' (code: ' + insertError.code + ')');
                    console.error('INSERT error:', insertError);
                } else {
                    results.push('INSERT OK - ID: ' + insertData[0]?.id);
                    console.log('INSERT data:', insertData);
                    
                    // Test 3: DELETE test row
                    console.log('Test DELETE...');
                    const { error: deleteError } = await supabase.from('rapports').delete().eq('redacteur', '__TEST_CONNECTION__');
                    if (deleteError) {
                        results.push('DELETE WARN: ' + deleteError.message);
                    } else {
                        results.push('DELETE OK');
                    }
                }
            } catch (err) {
                results.push('EXCEPTION: ' + err.message);
                console.error('Test exception:', err);
            }
            
            const summary = results.join('\n');
            console.log('TEST SUPABASE - Resultats:\n' + summary);
            alert('TEST SUPABASE:\n\n' + summary);
            return results;
        };
        
        // Expose for console debugging
        window.testSupabase = testSupabaseConnection;
        window.supabaseClient = supabase;
        
        const submitRapport = async (rapport) => {
            console.log('SUBMIT START - Rapport:', rapport.redacteur, rapport.date);
            
            // Prepare data for Supabase (snake_case)
            const supabaseData = {
                date: rapport.date,
                redacteur: rapport.redacteur,
                projet: rapport.projet,
                projet_nom: rapport.projetNom,
                adresse: rapport.adresse,
                meteo: rapport.meteo,
                temperature: rapport.temperature ? parseInt(rapport.temperature) : null,
                main_oeuvre: rapport.mainOeuvre || [],
                materiaux: rapport.materiaux || [],
                equipements: rapport.equipements || [],
                ordres_travail: rapport.ordresTravail || [],
                reunions: rapport.reunions || [],
                notes_generales: rapport.notesGenerales || '',
                problemes_securite: rapport.problemesSecurite || '',
                total_heures_mo: rapport.totalHeuresMO || 0,
                total_photos: rapport.totalPhotos || 0,
                has_extras: rapport.hasExtras || false,
                total_extras: rapport.totalExtras || 0
            };
            
            console.log('Data prepared:', JSON.stringify(supabaseData).substring(0, 200) + '...');
            
            // Submit to Supabase
            console.log('Sending to Supabase...');
            const { data, error } = await supabase.from('rapports').insert([supabaseData]).select();
            
            console.log('Supabase response - data:', data, 'error:', error);
            
            // Check for real errors (not empty objects)
            if (error && error.message) {
                console.error('SUPABASE ERROR:', error.message, error.code, error.details);
                
                // Save to localStorage as backup
                const pending = JSON.parse(localStorage.getItem('dr_rapports_pending') || '[]');
                pending.push({ ...rapport, failedAt: new Date().toISOString(), errorMsg: error.message });
                localStorage.setItem('dr_rapports_pending', JSON.stringify(pending));
                console.log('Saved to localStorage as backup');
                
                throw new Error('Erreur Supabase: ' + error.message);
            }
            
            if (!data || data.length === 0) {
                console.error('NO DATA RETURNED - Insert may have failed silently');
                throw new Error('Aucune donnee retournee - verifiez les permissions RLS');
            }
            
            console.log('SUCCESS! Rapport saved with ID:', data[0].id);
            
            // Email backup (non-blocking)
            sendEmailBackup(rapport).catch(e => console.warn('Email backup failed:', e));
            
            return data[0];
        };
        
        // G√©olocalisation
        const getGeoLocation = () => {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve({ latitude: null, longitude: null, enabled: false, error: 'Non support√©' });
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            enabled: true
                        });
                    },
                    (error) => {
                        resolve({ latitude: null, longitude: null, enabled: false, error: error.message });
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            });
        };
        
        // ============== ICONS ==============
        const Icons = {
            camera: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            clock: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>,
            box: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>,
            users: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            tool: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            dollar: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            meeting: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            alert: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>,
            plus: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>,
            trash: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>,
            send: <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>,
            check: <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#22c55e" strokeWidth="2" strokeLinecap="round"><path d="M20 6L9 17l-5-5" strokeDasharray="100" className="animate-check"/></svg>,
            sun: <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>,
            cloud: <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
            rain: <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M16 13v8M8 13v8M12 15v8M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>,
            snow: <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"/><path d="M8 16h.01M8 20h.01M12 18h.01M12 22h.01M16 16h.01M16 20h.01"/></svg>,
            chevronLeft: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M15 18l-6-6 6-6"/></svg>,
            chevronRight: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M9 18l6-6-6-6"/></svg>,
            ai: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>,
            scan: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="1"/></svg>,
            location: <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            edit: <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
        };
        
        // ============== COMPONENTS ==============
        
        // Header with hidden test (triple-tap logo = test Supabase)
        const Header = () => {
            const [tapCount, setTapCount] = React.useState(0);
            const tapTimer = React.useRef(null);
            
            const handleLogoTap = () => {
                setTapCount(prev => prev + 1);
                clearTimeout(tapTimer.current);
                tapTimer.current = setTimeout(() => setTapCount(0), 600);
                
                if (tapCount >= 2) {
                    setTapCount(0);
                    if (window.testSupabase) {
                        window.testSupabase();
                    }
                }
            };
            
            return (
                <header className="glass sticky top-0 z-50 px-4 py-3 safe-area-top">
                    <div className="max-w-2xl mx-auto flex items-center gap-3">
                        <div 
                            onClick={handleLogoTap}
                            className="w-11 h-11 bg-[#E63946] rounded-xl flex items-center justify-center font-bebas text-white text-xl shadow-lg shadow-red-500/20 cursor-pointer select-none"
                        >DR</div>
                        <div>
                            <h1 className="font-bebas text-white text-xl tracking-wide">RAPPORT JOURNALIER</h1>
                            <p className="text-[10px] text-gray-500 -mt-0.5">Groupe DR Electrique Inc.</p>
                        </div>
                    </div>
                </header>
            );
        };
        
        // Section Component
        const Section = ({ icon, title, subtitle, color, children }) => (
            <div className="rounded-2xl overflow-hidden bg-[#141414] border border-white/5 animate-slide-up">
                <div className="section-header px-4 py-3 flex items-center gap-3" style={{ '--color': color }}>
                    <span className="text-white/90">{icon}</span>
                    <div>
                        <h3 className="font-bebas text-white tracking-wide text-sm">{title}</h3>
                        {subtitle && <p className="text-[10px] text-white/60 -mt-0.5">{subtitle}</p>}
                    </div>
                </div>
                <div className="p-4">{children}</div>
            </div>
        );
        
        // ============== TIME PICKER (Modification #1) ==============
        const TimePicker = ({ value, onChange, label }) => {
            // value format: "HH:MM" ou { hours: 0, minutes: 0 }
            const parseTime = (val) => {
                if (typeof val === 'string' && val.includes(':')) {
                    const [h, m] = val.split(':').map(Number);
                    return { hours: h || 0, minutes: m || 0 };
                }
                return { hours: 0, minutes: 0 };
            };

            const time = parseTime(value);

            const formatTime = (h, m) => {
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };

            const adjustHours = (delta) => {
                let newHours = time.hours + delta;
                if (newHours > 23) newHours = 0;
                if (newHours < 0) newHours = 23;
                onChange(formatTime(newHours, time.minutes));
            };

            const handleMinutesChange = (newMinutes) => {
                onChange(formatTime(time.hours, parseInt(newMinutes)));
            };

            return (
                <div className="flex flex-col gap-1">
                    {label && <label className="text-[10px] text-gray-500 font-medium">{label}</label>}
                    <div className="flex items-center gap-2">
                        {/* Hours section with UP/DOWN arrows */}
                        <div className="flex flex-col items-center">
                            <button
                                type="button"
                                onClick={() => adjustHours(1)}
                                className="time-picker-btn w-10 h-8 text-lg"
                                title="Heures +1"
                            >
                                ‚ñ≤
                            </button>
                            <div className="time-display text-white bg-black/40 px-3 py-1 rounded-lg border border-white/10 text-xl min-w-[52px]">
                                {String(time.hours).padStart(2, '0')}
                            </div>
                            <button
                                type="button"
                                onClick={() => adjustHours(-1)}
                                className="time-picker-btn w-10 h-8 text-lg"
                                title="Heures -1"
                            >
                                ‚ñº
                            </button>
                        </div>

                        <span className="text-white text-2xl font-bebas">:</span>

                        {/* Minutes section with dropdown */}
                        <div className="flex flex-col items-center">
                            <select
                                value={time.minutes}
                                onChange={(e) => handleMinutesChange(e.target.value)}
                                className="time-display text-white bg-black/40 px-3 py-2 rounded-lg border border-white/10 text-xl min-w-[58px] text-center cursor-pointer"
                                style={{
                                    backgroundImage: 'none',
                                    paddingRight: '12px',
                                    appearance: 'none',
                                    WebkitAppearance: 'none'
                                }}
                            >
                                <option value={0}>00</option>
                                <option value={15}>15</option>
                                <option value={30}>30</option>
                                <option value={45}>45</option>
                            </select>
                        </div>
                    </div>
                    <p className="text-[9px] text-gray-600">‚ñ≤‚ñº Heures | Minutes ‚ñº</p>
                </div>
            );
        };
        
        // ============== PHOTO UPLOAD WITH GPS (Modification #3) ==============
        const PhotoUploadGPS = ({ photos, setPhotos, label, accent = "#22c55e", category }) => {
            const inputRef = useRef();
            const [gpsStatus, setGpsStatus] = useState(null);
            
            const handleFiles = async (e) => {
                const files = Array.from(e.target.files);
                
                // Get GPS location first
                setGpsStatus('fetching');
                const geo = await getGeoLocation();
                setGpsStatus(geo.enabled ? 'success' : 'disabled');
                
                for (const file of files) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Photo trop grosse (max 5MB)');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const newPhoto = {
                            id: generateId(),
                            data: ev.target.result,
                            timestamp: new Date().toISOString(),
                            category: category,
                            geolocation: {
                                latitude: geo.latitude,
                                longitude: geo.longitude,
                                accuracy: geo.accuracy,
                                enabled: geo.enabled
                            }
                        };
                        setPhotos(prev => [...prev, newPhoto]);
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = '';
                
                // Reset GPS status after 3 seconds
                setTimeout(() => setGpsStatus(null), 3000);
            };
            
            return (
                <div className="space-y-2">
                    <div className="photo-grid">
                        {photos.map(photo => (
                            <div key={photo.id} className="relative group">
                                <img src={photo.data} className="photo-item w-full border border-white/10" alt="" />
                                {photo.geolocation?.enabled && (
                                    <div className="absolute bottom-1 left-1 gps-badge flex items-center gap-1">
                                        {Icons.location} GPS
                                    </div>
                                )}
                                <button
                                    type="button"
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        e.preventDefault();
                                        setPhotos(prev => prev.filter(p => p.id !== photo.id));
                                    }}
                                    className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg"
                                >√ó</button>
                            </div>
                        ))}
                        <button
                            type="button"
                            onClick={() => inputRef.current?.click()}
                            className="aspect-square border-2 border-dashed rounded-xl flex flex-col items-center justify-center transition-all active:scale-95"
                            style={{ borderColor: `${accent}50`, color: accent }}
                        >
                            {Icons.camera}
                            <span className="text-[9px] mt-1 font-medium">{label}</span>
                            {gpsStatus === 'fetching' && <span className="text-[8px] text-blue-400 mt-0.5">üìç...</span>}
                            {gpsStatus === 'success' && <span className="text-[8px] text-green-400 mt-0.5">üìç OK</span>}
                        </button>
                    </div>
                    <input ref={inputRef} type="file" accept="image/*" capture="environment" multiple onChange={handleFiles} className="hidden" />
                </div>
            );
        };
        
        // ============== MATERIAL SCANNER (Modification #2) ==============
        const MaterialScanner = ({ onMaterialDetected }) => {
            const inputRef = useRef();
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [detectedMaterial, setDetectedMaterial] = useState(null);
            const [editMode, setEditMode] = useState(false);
            const [editedItem, setEditedItem] = useState('');
            const [editedQty, setEditedQty] = useState('');
            
            const handleCapture = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setIsAnalyzing(true);
                setDetectedMaterial(null);
                
                // Convert to base64
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const imageData = ev.target.result;
                    const base64Data = imageData.split(',')[1];
                    const mediaType = file.type || 'image/jpeg';
                    
                    try {
                        // Claude Vision API call - REQUIRES BACKEND PROXY FOR PRODUCTION
                        // WARNING: API keys should NEVER be exposed in client-side code
                        // Set up a serverless function (Netlify Functions) to proxy API calls
                        const response = await fetch("/.netlify/functions/claude-vision", {
                            method: "POST",
                            headers: { 
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                model: "claude-sonnet-4-20250514",
                                max_tokens: 500,
                                messages: [{
                                    role: "user",
                                    content: [
                                        {
                                            type: "image",
                                            source: { type: "base64", media_type: mediaType, data: base64Data }
                                        },
                                        {
                                            type: "text",
                                            text: `Analyse cette photo de mat√©riel √©lectrique. Identifie le mat√©riel et estime la quantit√© visible.
                                            
R√©ponds UNIQUEMENT en JSON valide, sans markdown:
{"item": "nom du mat√©riel √©lectrique", "quantite": "nombre estim√©", "unite": "unit√©|pi|m|rouleau|bo√Æte", "confidence": 0.85}

Mat√©riaux connus: ${MATERIAUX_COMMUNS.slice(0, 15).join(', ')}

Si tu ne reconnais pas de mat√©riel √©lectrique, r√©ponds: {"item": "Non identifi√©", "quantite": "1", "unite": "unit√©", "confidence": 0.0}`
                                        }
                                    ]
                                }]
                            })
                        });
                        
                        const data = await response.json();
                        const text = data.content?.[0]?.text || '{}';
                        const cleanJson = text.replace(/```json|```/g, '').trim();
                        const detected = JSON.parse(cleanJson);
                        detected.image = imageData;
                        
                        setDetectedMaterial(detected);
                        setEditedItem(detected.item);
                        setEditedQty(detected.quantite);
                    } catch (err) {
                        console.error('Claude API error:', err);
                        // Fallback to manual entry
                        setDetectedMaterial({
                            item: "Erreur d√©tection",
                            quantite: "1",
                            unite: "unit√©",
                            confidence: 0,
                            image: imageData,
                            error: true
                        });
                        setEditedItem('');
                        setEditedQty('1');
                    }
                    
                    setIsAnalyzing(false);
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };
            
            const confirmMaterial = () => {
                if (editedItem && editedQty) {
                    onMaterialDetected({
                        item: editedItem,
                        quantite: editedQty,
                        unite: detectedMaterial?.unite || 'unit√©',
                        detectedByAI: true,
                        confidence: detectedMaterial?.confidence
                    });
                    setDetectedMaterial(null);
                    setEditMode(false);
                    setEditedItem('');
                    setEditedQty('');
                }
            };
            
            const cancelDetection = () => {
                setDetectedMaterial(null);
                setEditMode(false);
            };
            
            return (
                <div className="space-y-3">
                    {/* Scan Button */}
                    {!detectedMaterial && !isAnalyzing && (
                        <button
                            type="button"
                            onClick={() => inputRef.current?.click()}
                            className="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl text-white font-medium flex items-center justify-center gap-2 active:scale-[0.98] transition-transform"
                        >
                            {Icons.scan}
                            üì∑ Scanner un mat√©riel (IA)
                        </button>
                    )}
                    
                    {/* Analyzing State */}
                    {isAnalyzing && (
                        <div className="ai-analyzing rounded-xl p-4 text-center animate-slide-up">
                            <div className="flex items-center justify-center gap-2 text-purple-400">
                                <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                                </svg>
                                <span className="animate-analyzing">Claude analyse l'image...</span>
                            </div>
                        </div>
                    )}
                    
                    {/* Detection Result */}
                    {detectedMaterial && (
                        <div className="ai-analyzing rounded-xl p-4 animate-slide-up">
                            <div className="flex items-start gap-3">
                                <img src={detectedMaterial.image} className="w-16 h-16 rounded-lg object-cover" alt="" />
                                <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="text-[10px] bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full">
                                            ü§ñ D√©tect√© {Math.round(detectedMaterial.confidence * 100)}%
                                        </span>
                                    </div>
                                    
                                    {editMode ? (
                                        <div className="space-y-2">
                                            <input
                                                type="text"
                                                value={editedItem}
                                                onChange={(e) => setEditedItem(e.target.value)}
                                                className="w-full px-3 py-2 rounded-lg text-sm"
                                                placeholder="Nom du mat√©riel"
                                                list="materials-list"
                                            />
                                            <datalist id="materials-list">
                                                {MATERIAUX_COMMUNS.map(m => <option key={m} value={m} />)}
                                            </datalist>
                                            <div className="flex gap-2">
                                                <input
                                                    type="number"
                                                    value={editedQty}
                                                    onChange={(e) => setEditedQty(e.target.value)}
                                                    className="w-20 px-3 py-2 rounded-lg text-sm"
                                                    placeholder="Qt√©"
                                                />
                                                <select 
                                                    className="flex-1 px-3 py-2 rounded-lg text-sm"
                                                    defaultValue={detectedMaterial.unite}
                                                >
                                                    <option>unit√©</option>
                                                    <option>pi</option>
                                                    <option>m</option>
                                                    <option>rouleau</option>
                                                    <option>bo√Æte</option>
                                                </select>
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <p className="text-white font-medium">{detectedMaterial.item}</p>
                                            <p className="text-sm text-gray-400">Quantit√©: {detectedMaterial.quantite} {detectedMaterial.unite}</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="flex gap-2 mt-3">
                                {!editMode && (
                                    <button
                                        type="button"
                                        onClick={() => setEditMode(true)}
                                        className="flex-1 py-2 bg-white/10 rounded-lg text-white text-sm flex items-center justify-center gap-1"
                                    >
                                        {Icons.edit} Modifier
                                    </button>
                                )}
                                <button
                                    type="button"
                                    onClick={confirmMaterial}
                                    className="flex-1 py-2 bg-green-600 rounded-lg text-white text-sm font-medium"
                                >
                                    ‚úì Ajouter
                                </button>
                                <button
                                    type="button"
                                    onClick={cancelDetection}
                                    className="py-2 px-4 bg-red-600/20 rounded-lg text-red-400 text-sm"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    )}
                    
                    <input ref={inputRef} type="file" accept="image/*" capture="environment" onChange={handleCapture} className="hidden" />
                </div>
            );
        };
        
        // ============== DYNAMIC ROWS ==============
        const DynamicRows = ({ rows, setRows, fields, addLabel, color = "#E63946" }) => {
            const addRow = () => {
                const newRow = { id: generateId() };
                fields.forEach(f => newRow[f.key] = f.default || '');
                setRows([...rows, newRow]);
            };
            
            const updateRow = (id, key, value) => {
                setRows(rows.map(r => r.id === id ? { ...r, [key]: value } : r));
            };
            
            const removeRow = (id) => {
                if (rows.length > 1) setRows(rows.filter(r => r.id !== id));
            };
            
            return (
                <div className="space-y-3">
                    {rows.map((row) => (
                        <div key={row.id} className="flex gap-2 animate-slide-up">
                            <div className="flex-1 grid gap-2" style={{ gridTemplateColumns: fields.map(f => f.width || '1fr').join(' ') }}>
                                {fields.map(field => (
                                    field.type === 'select' ? (
                                        <select
                                            key={field.key}
                                            value={row[field.key] || ''}
                                            onChange={(e) => updateRow(row.id, field.key, e.target.value)}
                                            className="px-3 py-3 rounded-xl"
                                        >
                                            <option value="">{field.placeholder}</option>
                                            {field.options?.map(opt => (
                                                <option key={opt.value || opt} value={opt.value || opt}>{opt.label || opt}</option>
                                            ))}
                                        </select>
                                    ) : field.type === 'datalist' ? (
                                        <div key={field.key}>
                                            <input
                                                list={`list-${field.key}-${row.id}`}
                                                value={row[field.key] || ''}
                                                onChange={(e) => updateRow(row.id, field.key, e.target.value)}
                                                placeholder={field.placeholder}
                                                className="w-full px-3 py-3 rounded-xl"
                                            />
                                            <datalist id={`list-${field.key}-${row.id}`}>
                                                {field.options?.map(opt => <option key={opt} value={opt} />)}
                                            </datalist>
                                        </div>
                                    ) : field.type === 'time-picker' ? (
                                        <TimePicker
                                            key={field.key}
                                            value={row[field.key] || '06:00'}
                                            onChange={(val) => updateRow(row.id, field.key, val)}
                                            label={field.placeholder}
                                        />
                                    ) : (
                                        <input
                                            key={field.key}
                                            type={field.type || 'text'}
                                            inputMode={field.type === 'number' ? 'decimal' : 'text'}
                                            placeholder={field.placeholder}
                                            value={row[field.key] || ''}
                                            onChange={(e) => updateRow(row.id, field.key, e.target.value)}
                                            className="px-3 py-3 rounded-xl"
                                        />
                                    )
                                ))}
                            </div>
                            <button 
                                type="button"
                                onClick={() => removeRow(row.id)} 
                                className="p-3 text-gray-600 hover:text-red-500 active:scale-95 transition-all rounded-xl"
                                disabled={rows.length === 1}
                            >
                                {Icons.trash}
                            </button>
                        </div>
                    ))}
                    <button 
                        type="button"
                        onClick={addRow}
                        className="w-full py-3 border-2 border-dashed rounded-xl flex items-center justify-center gap-2 text-sm font-medium transition-all active:scale-[0.98]"
                        style={{ borderColor: `${color}40`, color: color }}
                    >
                        {Icons.plus} {addLabel}
                    </button>
                </div>
            );
        };
        
        // ============== MAIN FORM ==============
        const RapportForm = () => {
            const [step, setStep] = useState('form');
            const [data, setData] = useState({
                projet: 'PRJ-001',
                date: getTodayStr(),
                adresse: '1500 Atwater, Montr√©al, QC H3Z 1X5',
                meteo: '',
                temperature: '',
                redacteur: 'Maxime Robert',
                // Main d'oeuvre avec heures d√©but/fin
                mainOeuvre: [{ id: generateId(), employe: '', heureDebut: '06:00', heureFin: '14:15', description: '' }],
                materiaux: [{ id: generateId(), item: '', quantite: '', unite: 'unit√©', detectedByAI: false }],
                equipements: [{ id: generateId(), nom: '', heures: '', description: '' }],
                soustraitants: [{ id: generateId(), entreprise: '', nbPersonnes: '', heures: '', description: '' }],
                ordresTravail: [{ id: generateId(), description: '', isExtra: false, montantExtra: '', status: 'en_cours' }],
                reunions: [{ id: generateId(), type: '', participants: '', notes: '' }],
                photosGenerales: [],
                photosAvant: [],
                photosApres: [],
                photosProblemes: [],
                evenements: '',
                problemesSecurite: '',
                notesGenerales: ''
            });
            
            const update = (key, val) => setData(prev => ({ ...prev, [key]: val }));
            
            // Calculate hours from time range
            const calculateHours = (debut, fin) => {
                if (!debut || !fin) return 0;
                const [h1, m1] = debut.split(':').map(Number);
                const [h2, m2] = fin.split(':').map(Number);
                const start = h1 + m1/60;
                const end = h2 + m2/60;
                return Math.max(0, end - start);
            };
            
            // Handle AI-detected material
            const handleMaterialDetected = (material) => {
                const newMaterial = {
                    id: generateId(),
                    ...material
                };
                update('materiaux', [...data.materiaux, newMaterial]);
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!data.redacteur) {
                    alert('S√©lectionne ton nom!');
                    return;
                }
                if (!data.projet) {
                    alert('S√©lectionne le projet!');
                    return;
                }
                
                setStep('submitting');
                
                // Calculate total hours from time ranges
                const totalHeuresMO = data.mainOeuvre.reduce((acc, m) => {
                    if (!m.employe) return acc;
                    return acc + calculateHours(m.heureDebut, m.heureFin);
                }, 0);
                
                const rapport = {
                    ...data,
                    id: generateId(),
                    submittedAt: new Date().toISOString(),
                    totalHeuresMO,
                    totalPhotos: data.photosGenerales.length + data.photosAvant.length + data.photosApres.length + data.photosProblemes.length,
                    hasExtras: data.ordresTravail.some(o => o.isExtra),
                    nbExtras: data.ordresTravail.filter(o => o.isExtra).length,
                    totalExtras: data.ordresTravail.filter(o => o.isExtra).reduce((acc, o) => acc + (parseFloat(o.montantExtra) || 0), 0),
                    // GPS data is already embedded in photos
                    hasGPSPhotos: [...data.photosGenerales, ...data.photosAvant, ...data.photosApres, ...data.photosProblemes].some(p => p.geolocation?.enabled)
                };
                
                try {
                    await submitRapport(rapport);
                    setStep('success');
                } catch (error) {
                    console.error('Submit error:', error);
                    savePendingRapport(rapport);
                    setStep('offline');
                }
            };
            
            const resetForm = () => {
                setData({
                    projet: 'PRJ-001',
                    date: getTodayStr(),
                    adresse: '1500 Atwater, Montr√©al, QC H3Z 1X5',
                    meteo: '',
                    temperature: '',
                    redacteur: data.redacteur,
                    mainOeuvre: [{ id: generateId(), employe: '', heureDebut: '06:00', heureFin: '14:15', description: '' }],
                    materiaux: [{ id: generateId(), item: '', quantite: '', unite: 'unit√©', detectedByAI: false }],
                    equipements: [{ id: generateId(), nom: '', heures: '', description: '' }],
                    soustraitants: [{ id: generateId(), entreprise: '', nbPersonnes: '', heures: '', description: '' }],
                    ordresTravail: [{ id: generateId(), description: '', isExtra: false, montantExtra: '', status: 'en_cours' }],
                    reunions: [{ id: generateId(), type: '', participants: '', notes: '' }],
                    photosGenerales: [],
                    photosAvant: [],
                    photosApres: [],
                    photosProblemes: [],
                    evenements: '',
                    problemesSecurite: '',
                    notesGenerales: ''
                });
                setStep('form');
            };
            
            // SUCCESS SCREEN
            if (step === 'success') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="glass rounded-3xl p-8 text-center max-w-sm w-full animate-slide-up">
                            <div className="w-24 h-24 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border-2 border-green-500/30">
                                {Icons.check}
                            </div>
                            <h2 className="font-bebas text-3xl text-white mb-2">RAPPORT ENVOY√â!</h2>
                            <p className="text-gray-400 mb-1">Merci {data.redacteur?.split(' ')[0]}!</p>
                            <p className="text-sm text-gray-500 mb-8">Ton rapport a √©t√© transmis au dashboard.</p>
                            <button 
                                type="button"
                                onClick={resetForm}
                                className="w-full py-4 bg-[#E63946] text-white font-bebas text-lg tracking-wide rounded-xl active:scale-[0.98] transition-transform"
                            >
                                NOUVEAU RAPPORT
                            </button>
                        </div>
                    </div>
                );
            }
            
            
            // OFFLINE SCREEN
            if (step === 'offline') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="glass rounded-3xl p-8 text-center max-w-sm w-full animate-slide-up">
                            <div className="w-24 h-24 bg-yellow-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border-2 border-yellow-500/30">
                                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#eab308" strokeWidth="2">
                                    <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </div>
                            <h2 className="font-bebas text-3xl text-white mb-2">SAUVEGARD√â LOCALEMENT</h2>
                            <p className="text-yellow-400 mb-1">Connexion √©chou√©e</p>
                            <p className="text-sm text-gray-500 mb-8">Ton rapport est sauvegard√© localement et sera envoy√© automatiquement quand la connexion sera r√©tablie.</p>
                            <button 
                                type="button"
                                onClick={resetForm}
                                className="w-full py-4 bg-yellow-600 text-white font-bebas text-lg tracking-wide rounded-xl active:scale-[0.98] transition-transform"
                            >
                                NOUVEAU RAPPORT
                            </button>
                        </div>
                    </div>
                );
            }

            // SUBMITTING SCREEN
            if (step === 'submitting') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="text-center">
                            <div className="w-16 h-16 border-4 border-[#E63946] border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                            <p className="text-white font-medium">Envoi en cours...</p>
                            <p className="text-gray-500 text-sm mt-1">Transfert des donn√©es et photos</p>
                        </div>
                    </div>
                );
            }
            
            // MAIN FORM
            return (
                <form onSubmit={handleSubmit} className="max-w-2xl mx-auto p-4 space-y-4 pb-32">
                    
                    {/* EN-T√äTE */}
                    <div className="glass rounded-2xl p-4 space-y-4 animate-slide-up">
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-[11px] text-gray-500 mb-1.5 block font-medium">PROJET *</label>
                                <select value={data.projet} onChange={(e) => update('projet', e.target.value)} className="w-full px-3 py-3 rounded-xl" required>
                                    <option value="">S√©lectionner...</option>
                                    {PROJETS.map(p => <option key={p.id} value={p.id}>{p.nom}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-[11px] text-gray-500 mb-1.5 block font-medium">DATE *</label>
                                <input type="date" value={data.date} onChange={(e) => update('date', e.target.value)} className="w-full px-3 py-3 rounded-xl" required />
                            </div>
                        </div>
                        
                        <div>
                            <label className="text-[11px] text-gray-500 mb-1.5 block font-medium">ADRESSE CHANTIER</label>
                            <input type="text" value={data.adresse} onChange={(e) => update('adresse', e.target.value)} placeholder="123 rue Exemple, Montr√©al" className="w-full px-3 py-3 rounded-xl" />
                        </div>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-[11px] text-gray-500 mb-2 block font-medium">M√âT√âO</label>
                                <div className="grid grid-cols-4 gap-2">
                                    {[
                                        { k: 'soleil', i: Icons.sun },
                                        { k: 'nuageux', i: Icons.cloud },
                                        { k: 'pluie', i: Icons.rain },
                                        { k: 'neige', i: Icons.snow }
                                    ].map(m => (
                                        <button 
                                            key={m.k} 
                                            type="button"
                                            onClick={() => update('meteo', m.k)}
                                            className={`p-2 rounded-xl border-2 transition-all active:scale-95 ${
                                                data.meteo === m.k 
                                                    ? 'border-[#E63946] bg-[#E63946]/10 text-[#E63946]' 
                                                    : 'border-transparent bg-black/30 text-gray-500'
                                            }`}
                                        >
                                            {m.i}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <label className="text-[11px] text-gray-500 mb-1.5 block font-medium">TEMP. (¬∞C)</label>
                                <input type="number" inputMode="numeric" value={data.temperature} onChange={(e) => update('temperature', e.target.value)} placeholder="-5" className="w-full px-3 py-3 rounded-xl" />
                            </div>
                        </div>
                        
                        <div>
                            <label className="text-[11px] text-gray-500 mb-1.5 block font-medium">TON NOM *</label>
                            <select value={data.redacteur} onChange={(e) => update('redacteur', e.target.value)} className="w-full px-3 py-3 rounded-xl" required>
                                <option value="">Qui es-tu?</option>
                                {EMPLOYES.map(e => <option key={e.id} value={e.nom}>{e.nom} ({e.role})</option>)}
                            </select>
                        </div>
                    </div>
                    
                    {/* MAIN D'OEUVRE - AVEC TIME PICKER */}
                    <Section icon={Icons.clock} title="TEMPS - MAIN D'OEUVRE" subtitle="Heures d√©but/fin avec fl√®ches" color="#3b82f6">
                        <div className="space-y-4">
                            {data.mainOeuvre.map((row, idx) => (
                                <div key={row.id} className="bg-black/20 rounded-xl p-3 space-y-3 animate-slide-up">
                                    <div className="flex items-center justify-between">
                                        <select
                                            value={row.employe}
                                            onChange={(e) => {
                                                const updated = [...data.mainOeuvre];
                                                updated[idx].employe = e.target.value;
                                                update('mainOeuvre', updated);
                                            }}
                                            className="flex-1 px-3 py-3 rounded-xl mr-2"
                                        >
                                            <option value="">S√©lectionner employ√©</option>
                                            {WORKERS.map((w, i) => <option key={i} value={w}>{w}</option>)}
                                        </select>
                                        <button 
                                            type="button"
                                            onClick={() => {
                                                if (data.mainOeuvre.length > 1) {
                                                    update('mainOeuvre', data.mainOeuvre.filter(r => r.id !== row.id));
                                                }
                                            }}
                                            className="p-2 text-gray-600 hover:text-red-500"
                                        >
                                            {Icons.trash}
                                        </button>
                                    </div>
                                    
                                    <div className="flex items-center justify-around gap-4">
                                        <TimePicker
                                            value={row.heureDebut}
                                            onChange={(val) => {
                                                const updated = [...data.mainOeuvre];
                                                updated[idx].heureDebut = val;
                                                update('mainOeuvre', updated);
                                            }}
                                            label="D√âBUT"
                                        />
                                        <div className="text-gray-600 text-2xl">‚Üí</div>
                                        <TimePicker
                                            value={row.heureFin}
                                            onChange={(val) => {
                                                const updated = [...data.mainOeuvre];
                                                updated[idx].heureFin = val;
                                                update('mainOeuvre', updated);
                                            }}
                                            label="FIN"
                                        />
                                    </div>
                                    
                                    {row.employe && (
                                        <div className="text-center text-sm text-blue-400 bg-blue-400/10 py-2 rounded-lg">
                                            Total: <span className="font-bold">{calculateHours(row.heureDebut, row.heureFin).toFixed(1)}h</span>
                                        </div>
                                    )}
                                    
                                    <input
                                        type="text"
                                        value={row.description}
                                        onChange={(e) => {
                                            const updated = [...data.mainOeuvre];
                                            updated[idx].description = e.target.value;
                                            update('mainOeuvre', updated);
                                        }}
                                        placeholder="Description des travaux effectu√©s..."
                                        className="w-full px-3 py-2 rounded-xl text-sm"
                                    />
                                </div>
                            ))}
                            
                            <button 
                                type="button"
                                onClick={() => update('mainOeuvre', [...data.mainOeuvre, { id: generateId(), employe: '', heureDebut: '06:00', heureFin: '14:15', description: '' }])}
                                className="w-full py-3 border-2 border-dashed border-blue-500/40 rounded-xl text-blue-500 flex items-center justify-center gap-2 text-sm font-medium"
                            >
                                {Icons.plus} Ajouter employ√©
                            </button>
                        </div>
                    </Section>
                    
                    {/* MAT√âRIAUX - AVEC AI SCANNER */}
                    <Section icon={Icons.box} title="MAT√âRIAUX UTILIS√âS" subtitle="Scanner ou ajouter manuellement" color="#f59e0b">
                        <div className="space-y-4">
                            {/* AI Material Scanner */}
                            <MaterialScanner onMaterialDetected={handleMaterialDetected} />
                            
                            {/* Manual Entry */}
                            <div className="border-t border-white/10 pt-4">
                                <p className="text-xs text-gray-500 mb-3">Ou ajouter manuellement:</p>
                                <DynamicRows
                                    rows={data.materiaux}
                                    setRows={(rows) => update('materiaux', rows)}
                                    fields={[
                                        { key: 'item', placeholder: 'Mat√©riau', type: 'datalist', options: MATERIAUX_COMMUNS, width: '1fr' },
                                        { key: 'quantite', placeholder: 'Qt√©', type: 'number', width: '65px' },
                                        { key: 'unite', placeholder: 'Unit√©', type: 'select', options: ['unit√©', 'pi', 'm', 'rouleau', 'bo√Æte'], width: '80px' }
                                    ]}
                                    addLabel="Ajouter mat√©riau"
                                    color="#f59e0b"
                                />
                            </div>
                        </div>
                    </Section>
                    
                    {/* √âQUIPEMENTS */}
                    <Section icon={Icons.tool} title="√âQUIPEMENTS" subtitle="Outils et machinerie" color="#8b5cf6">
                        <DynamicRows
                            rows={data.equipements}
                            setRows={(rows) => update('equipements', rows)}
                            fields={[
                                { key: 'nom', placeholder: 'Equipement', type: 'select', options: ['Stanex', 'Perceur', 'Scie a chaine', 'Lift', 'Echafaud', 'Autre'], width: '1fr' },
                                { key: 'heures', placeholder: 'Hrs', type: 'number', width: '65px' },
                            ]}
                            addLabel="Ajouter √©quipement"
                            color="#8b5cf6"
                        />
                    </Section>
                    
                    {/* SOUS-TRAITANTS */}
                    <Section icon={Icons.users} title="SOUS-TRAITANTS" subtitle="Entreprises sur le chantier" color="#06b6d4">
                        <DynamicRows
                            rows={data.soustraitants}
                            setRows={(rows) => update('soustraitants', rows)}
                            fields={[
                                { key: 'entreprise', placeholder: 'Entreprise', width: '1fr' },
                                { key: 'nbPersonnes', placeholder: '#', type: 'number', width: '50px' },
                                { key: 'heures', placeholder: 'Hrs', type: 'number', width: '60px' },
                            ]}
                            addLabel="Ajouter sous-traitant"
                            color="#06b6d4"
                        />
                    </Section>
                    
                    {/* ORDRES DE TRAVAIL / EXTRAS */}
                    <Section icon={Icons.dollar} title="ORDRES DE TRAVAIL" subtitle="‚ö†Ô∏è Cocher les EXTRAS!" color="#eab308">
                        <div className="space-y-3">
                            {data.ordresTravail.map((ordre, idx) => (
                                <div key={ordre.id} className="bg-black/30 rounded-xl p-3 space-y-3 border border-white/5">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={ordre.description}
                                            onChange={(e) => {
                                                const updated = [...data.ordresTravail];
                                                updated[idx].description = e.target.value;
                                                update('ordresTravail', updated);
                                            }}
                                            placeholder="Description du travail"
                                            className="flex-1 px-3 py-3 rounded-xl"
                                        />
                                        <button 
                                            type="button"
                                            onClick={() => {
                                                if (data.ordresTravail.length > 1) {
                                                    update('ordresTravail', data.ordresTravail.filter(o => o.id !== ordre.id));
                                                }
                                            }}
                                            className="p-3 text-gray-600"
                                        >
                                            {Icons.trash}
                                        </button>
                                    </div>
                                    <div className="flex items-center gap-3 flex-wrap">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={ordre.isExtra}
                                                onChange={(e) => {
                                                    const updated = [...data.ordresTravail];
                                                    updated[idx].isExtra = e.target.checked;
                                                    update('ordresTravail', updated);
                                                }}
                                                className="w-5 h-5 rounded accent-yellow-500"
                                            />
                                            <span className="extra-badge text-white">üí∞ EXTRA</span>
                                        </label>
                                        {ordre.isExtra && (
                                            <input
                                                type="number"
                                                inputMode="decimal"
                                                value={ordre.montantExtra}
                                                onChange={(e) => {
                                                    const updated = [...data.ordresTravail];
                                                    updated[idx].montantExtra = e.target.value;
                                                    update('ordresTravail', updated);
                                                }}
                                                placeholder="Montant $"
                                                className="w-28 px-3 py-2 rounded-xl text-yellow-400"
                                            />
                                        )}
                                        <select
                                            value={ordre.status}
                                            onChange={(e) => {
                                                const updated = [...data.ordresTravail];
                                                updated[idx].status = e.target.value;
                                                update('ordresTravail', updated);
                                            }}
                                            className="px-3 py-2 rounded-xl text-sm"
                                        >
                                            <option value="en_cours">En cours</option>
                                            <option value="complete">Compl√©t√©</option>
                                            <option value="bloque">Bloqu√©</option>
                                        </select>
                                    </div>
                                </div>
                            ))}
                            <button 
                                type="button"
                                onClick={() => update('ordresTravail', [...data.ordresTravail, { id: generateId(), description: '', isExtra: false, montantExtra: '', status: 'en_cours' }])}
                                className="w-full py-3 border-2 border-dashed border-yellow-500/40 rounded-xl text-yellow-500 flex items-center justify-center gap-2 text-sm font-medium"
                            >
                                {Icons.plus} Ajouter ordre de travail
                            </button>
                        </div>
                    </Section>
                    
                    {/* R√âUNIONS */}
                    <Section icon={Icons.meeting} title="R√âUNIONS" subtitle="Rencontres de chantier" color="#6366f1">
                        <DynamicRows
                            rows={data.reunions}
                            setRows={(rows) => update('reunions', rows)}
                            fields={[
                                { key: 'type', placeholder: 'Type', type: 'select', options: ['Coordination', 'S√©curit√©', 'Client', 'Ing√©nieur', 'Autre'], width: '100px' },
                                { key: 'participants', placeholder: 'Participants', width: '1fr' },
                            ]}
                            addLabel="Ajouter r√©union"
                            color="#6366f1"
                        />
                    </Section>
                    
                    {/* PHOTOS AVEC GPS */}
                    <Section icon={Icons.camera} title="PHOTOS" subtitle="üìç G√©olocalisation automatique" color="#22c55e">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-black/30 rounded-xl p-3">
                                <p className="text-[10px] text-gray-400 mb-2 font-medium">üì∏ G√âN√âRALES</p>
                                <PhotoUploadGPS 
                                    photos={data.photosGenerales} 
                                    setPhotos={(p) => update('photosGenerales', p)} 
                                    label="Photo" 
                                    accent="#22c55e"
                                    category="GENERALES"
                                />
                            </div>
                            <div className="bg-black/30 rounded-xl p-3">
                                <p className="text-[10px] text-blue-400 mb-2 font-medium">üîú AVANT</p>
                                <PhotoUploadGPS 
                                    photos={data.photosAvant} 
                                    setPhotos={(p) => update('photosAvant', p)} 
                                    label="Avant" 
                                    accent="#3b82f6"
                                    category="AVANT"
                                />
                            </div>
                            <div className="bg-black/30 rounded-xl p-3">
                                <p className="text-[10px] text-green-400 mb-2 font-medium">‚úÖ APR√àS</p>
                                <PhotoUploadGPS 
                                    photos={data.photosApres} 
                                    setPhotos={(p) => update('photosApres', p)} 
                                    label="Apr√®s" 
                                    accent="#22c55e"
                                    category="APRES"
                                />
                            </div>
                            <div className="bg-black/30 rounded-xl p-3 border border-red-500/30">
                                <p className="text-[10px] text-red-400 mb-2 font-medium">‚ö†Ô∏è PROBL√àMES</p>
                                <PhotoUploadGPS 
                                    photos={data.photosProblemes} 
                                    setPhotos={(p) => update('photosProblemes', p)} 
                                    label="Probl√®me" 
                                    accent="#ef4444"
                                    category="PROBLEMES"
                                />
                            </div>
                        </div>
                        <p className="text-[10px] text-gray-600 mt-3 text-center">
                            üìç Les coordonn√©es GPS sont captur√©es automatiquement si activ√© sur ton t√©l√©phone
                        </p>
                    </Section>
                    
                    {/* NOTES */}
                    <Section icon={Icons.alert} title="NOTES & √âV√âNEMENTS" subtitle="Infos importantes" color="#64748b">
                        <div className="space-y-4">
                            <div>
                                <label className="text-[10px] text-gray-500 mb-1.5 block">√âv√©nements (visites, livraisons, retards...)</label>
                                <textarea 
                                    value={data.evenements} 
                                    onChange={(e) => update('evenements', e.target.value)} 
                                    rows={2} 
                                    className="w-full px-3 py-3 rounded-xl resize-none"
                                    placeholder="CNESST, CCQ, livraisons..."
                                />
                            </div>
                            <div>
                                <label className="text-[10px] text-red-400 mb-1.5 block">‚ö†Ô∏è Probl√®mes de s√©curit√©</label>
                                <textarea 
                                    value={data.problemesSecurite} 
                                    onChange={(e) => update('problemesSecurite', e.target.value)} 
                                    rows={2} 
                                    className="w-full px-3 py-3 rounded-xl resize-none border-red-500/30"
                                    placeholder="Risques, incidents, √©quipements d√©fectueux..."
                                />
                            </div>
                            <div>
                                <label className="text-[10px] text-gray-500 mb-1.5 block">Notes g√©n√©rales</label>
                                <textarea 
                                    value={data.notesGenerales} 
                                    onChange={(e) => update('notesGenerales', e.target.value)} 
                                    rows={3} 
                                    className="w-full px-3 py-3 rounded-xl resize-none"
                                    placeholder="Autres informations..."
                                />
                            </div>
                        </div>
                    </Section>
                    
                    {/* SUBMIT BUTTON */}
                    <button
                        type="submit"
                        className="fixed bottom-6 left-4 right-4 max-w-2xl mx-auto py-5 bg-[#E63946] text-white font-bebas text-xl tracking-wider rounded-2xl flex items-center justify-center gap-3 shadow-2xl shadow-red-500/30 animate-pulse-btn active:scale-[0.98] transition-transform z-40"
                    >
                        {Icons.send}
                        ENVOYER LE RAPPORT
                    </button>
                </form>
            );
        };
        
        // ============== APP ==============
        const App = () => (
            <div className="min-h-screen">
                <Header />
                <RapportForm />
            </div>
        );
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
